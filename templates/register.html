<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>×¨×™×©×•× ×œ×§×•×¨×¡ ×©×—×™×™×”</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="container">
        <h2>×¨×™×©×•× ×œ×§×•×¨×¡ ×©×—×™×™×”</h2>
        <!-- ×”×•×“×¢×” ×× ×”×¨×™×©×•× ×¡×’×•×¨ -->
        {% if not registration_active %}
        <div
            style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0; border: 2px solid #f5c6cb;">
            <h3>ğŸ›‘ ×”×¨×™×©×•× ×œ×§×•×¨×¡×™× ×¡×’×•×¨ ×›×¨×’×¢</h3>
            <p>× ×©××— ×œ×¨××•×ª×š ×‘×¤×¢× ×”×‘××” ×©×”×¨×™×©×•× ×™×¤×ª×—!</p>
        </div>
        {% endif %}

        <!-- ×—×œ×•× ×™×ª ×ª×©×œ×•× -->
        <div id="paymentModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span id="closeModal" class="close" style="cursor:pointer;">&times;</span>
                <h3>×‘×—×¨ ×¡×•×’ ×ª×©×œ×•×:</h3>
                <label>
                    <input type="radio" name="payment_type" value="private"> ×ª×©×œ×•× ×¤×¨×˜×™
                </label><br>
                <label>
                    <input type="radio" name="payment_type" value="insurance"> ×ª×©×œ×•× ×“×¨×š ×§×•×¤×ª ×—×•×œ×™×
                </label>

                <div id="insuranceOptions" class="insurance-options" style="display:none; margin-top:10px;">
                    <label>
                        <input type="radio" name="insurance_type" value="×××•×—×“×ª"> ×××•×—×“×ª
                        <div class="insurance-code">×§×•×“ ×”×ª×—×™×™×‘×•×ª: b99542</div>
                    </label><br>
                    <label>
                        <input type="radio" name="insurance_type" value="×œ××•××™×ª"> ×œ××•××™×ª
                        <div class="insurance-code">×§×•×“ ×”×ª×—×™×™×‘×•×ª: 93015</div>
                    </label>
                    <label for="insurance_email" style="margin-top:10px;">
                        ×™×© ×œ×©×œ× ×“××™ ×¨×™×©×•× ×¢×œ ×¡×š 100 ×©"×— ×•×‘× ×•×¡×£ ×œ×©×œ×•×— ×”×ª×—×™×™×‘×•×™×•×ª ×œ××™×™×œ: tnuakurs@gmail.com , ×‘××™×“×” ×•×œ×
                        ×™×©×œ×—×• ×›×œ ×”×”×ª×—×™×™×‘×•×™×•×ª ×™×™×’×‘×” ×ª×©×œ×•× × ×•×¡×£
                    </label>
                </div>

                <button id="payButton" class="btn-pay" style="margin-top:10px;">×©×œ×</button>
            </div>
        </div>
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        {% for msg in messages %}
        <div class="message"
            style="color: {% if category == 'error' %}red{% else %}green{% endif %}; margin-bottom: 10px;">
            {{ msg }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for msg in messages %}
                    <div class="message" style="color: {% if category == 'error' %}red{% else %}green{% endif %}; margin-bottom: 10px;">
                        {{ msg }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %} -->

        <form method="POST">
            <h4>×™×© ×œ×›×ª×•×‘ ××ª ×›×œ ×”×¤×¨×˜×™× ×‘×¢×‘×¨×™×ª</h4>
            <!-- ×”×¤×™×›×ª ×›×œ ×”×©×“×•×ª ×œ×œ× ×¤×¢×™×œ×™× ×× ×”×¨×™×©×•× ×¡×’×•×¨ -->
            <fieldset {% if not registration_active %}disabled{% endif %}>

                <label for="parent_name">×©× ×”×”×•×¨×”:</label>
                <input type="text" name="parent_name" id="parent_name" maxlength="30" pattern="[×-×ª\s]+"
                    oninput="this.value = this.value.replace(/[^×-×ª\s]/g, '')">

                <label for="parent_surname">×©× ××©×¤×—×”:</label>
                <input type="text" name="parent_surname" id="parent_surname" maxlength="30" pattern="[×-×ª\s]+"
                    oninput="this.value = this.value.replace(/[^×-×ª\s]/g, '')">

                <label for="email">××™××™×™×œ:</label>

                <input type="email" name="email" id="email" maxlength="100" placeholder="example@mail.com"
                    oninput="this.value = this.value.replace(/[^a-zA-Z0-9.@\-_+%]/g, '')"
                    style="direction: ltr; text-align: left;">
                <div id="email_error" style="color:red; font-size:0.9em;"></div>

                <label for="phone">×˜×œ×¤×•×Ÿ:</label>
                <input type="tel" name="phone" id="phone" maxlength="10" placeholder="05XXXXXXXX"
                    pattern="^0(?:[23489]|5[0-9])-?\d{7}$" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                    inputmode="numeric">
                <div id="phone_error" style="color:red; font-size:0.9em; margin-bottom:5px;"></div>

                <label for="child_name">×©× ×”×™×œ×“/×”:</label>
                <input type="text" name="child_name" id="child_name" maxlength="30" pattern="[×-×ª\s]+"
                    oninput="this.value = this.value.replace(/[^×-×ª\s]/g, '')">

                <label for="child_age"> ×’×™×œ ×”×™×œ×“/×”: (6-13)</label>
                <input type="number" name="child_age" id="child_age" min="6" max="13">

                <label for="id"> ×ª×¢×•×“×ª ×–×”×•×ª ×©×œ ×”×™×œ×“</label>
                <input type="text" name="id" id="id" maxlength="9" minlength="8" inputmode="numeric" pattern="\d{8,9}"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '')">

                <label for="child_gender">×‘×Ÿ/×‘×ª:</label>
                <select name="child_gender" id="child_gender">
                    <option value="" disabled selected>×‘×—×¨/×™</option>
                    <option value="boys">×‘×Ÿ</option>
                    <option value="girls">×‘×ª</option>
                </select>

                <label for="course">×‘×—×™×¨×ª ×§×•×¨×¡:</label>
                <select name="course" id="course">
                    <option value="" disabled selected>×‘×—×¨/×™ ×§×•×¨×¡</option>
                </select>

                <label for="group_type">×¡×•×’ ×§×‘×•×¦×”:</label>
                <select name="group_type" id="group_type">
                    <option value="" disabled selected>×‘×—×¨/×™ ×¡×•×’ ×§×‘×•×¦×”</option>
                </select>

                <!-- <div class="mb-3" style="margin-top: 15px;">
    <input type="checkbox" id="privacy" name="privacy" value="accepted" style="margin-right:8px;">
    <label for="privacy" style="display:inline;">
        ×× ×™ ×××©×¨/×ª ××ª <a href="/privacy-policy" target="_blank">××“×™× ×™×•×ª ×”×¤×¨×˜×™×•×ª</a> ×©×œ ×”××ª×¨
    </label>
</div> -->
                <div class="mb-3 privacy-container">
                    <input type="checkbox" id="privacy" name="privacy" value="accepted">
                    <label for="privacy">
                        ×× ×™ ×××©×¨/×ª ××ª ×¢×™×‘×•×“ ×”× ×ª×•× ×™× ×©×œ×™ ×‘×”×ª××
                        <a href="{{ url_for('privacy_policy') }}">×œ××“×™× ×™×•×ª ×”×¤×¨×˜×™×•×ª</a>
                    </label>
                </div>

                <!-- <button type="submit" class="btn-register">×”×¨×©××”</button> -->
                <button type="submit" class="btn-register" {% if not registration_active %}disabled
                    style="opacity: 0.5; cursor: not-allowed;" {% endif %}>
                    {% if not registration_active %}×”×¨×™×©×•× ×¡×’×•×¨{% else %}×”×¨×©××”{% endif %}
                </button>
            </fieldset>
        </form>
    </div>

    <!-- <script>
        const allCourses = {{ courses | tojson | safe }};
        const courseStatus = {{ course_status | tojson | safe }};
        const prices = {{ prices | tojson | safe }};

        const genderSelect = document.getElementById("child_gender");
        const courseSelect = document.getElementById("course");
        const submitButton = document.querySelector("button[type='submit']");
        const ageInput = document.getElementById("child_age");
        const groupSelect = document.getElementById("group_type");
        const emailInput = document.getElementById("email");
        const emailErrorDiv = document.getElementById("email_error");
        const phoneInput = document.getElementById("phone");
        const phoneErrorDiv = document.getElementById("phone_error");
        const form = document.querySelector("form");

        // ×¤×•× ×§×¦×™×•×ª ×‘×“×™×§×”
        function validateEmailClient(email) {
            const regex = /^[\w\.-]+@[\w\.-]+\.[a-zA-Z]{2,}$/;
            return regex.test(email);
        }

        function validatePhoneClient(phone) {
            const regex = /^(?:\+972|0)(?:5\d\d{7}|[23489]\d{7})$/;
            return regex.test(phone);
        }

        function validateHebrewName(name) {
            const regex = /^[×-×ª\s]+$/;
            return regex.test(name.trim());
        }

        // ×¤×•× ×§×¦×™×” ××¨×›×–×™×ª ×œ×‘×“×™×§×ª ×›×œ ×”×©×“×•×ª
        function validateAllFields() {
            let isValid = true;
            let errors = [];

            // ×‘×“×™×§×ª ×©× ×”×”×•×¨×”
            const parentName = document.getElementById("parent_name").value.trim();
            if (!parentName) {
                errors.push("×©×“×” '×©× ×”×”×•×¨×”' ×”×•× ×—×•×‘×”");
                isValid = false;
            } else if (!validateHebrewName(parentName)) {
                errors.push("×©× ×”×”×•×¨×” ××™× ×• ×—×•×§×™. ×™×© ×œ×”×©×ª××© ×¨×§ ×‘××•×ª×™×•×ª ×‘×¢×‘×¨×™×ª");
                isValid = false;
            }

            // ×‘×“×™×§×ª ×©× ××©×¤×—×”
            const parentSurname = document.getElementById("parent_surname").value.trim();
            if (!parentSurname) {
                errors.push("×©×“×” '×©× ××©×¤×—×”' ×”×•× ×—×•×‘×”");
                isValid = false;
            } else if (!validateHebrewName(parentSurname)) {
                errors.push("×©× ×”××©×¤×—×” ××™× ×• ×—×•×§×™. ×™×© ×œ×”×©×ª××© ×¨×§ ×‘××•×ª×™×•×ª ×‘×¢×‘×¨×™×ª");
                isValid = false;
            }

            // ×‘×“×™×§×ª ××™××™×™×œ
            const email = emailInput.value.trim();
            if (!email) {
                errors.push("×©×“×” '××™××™×™×œ' ×”×•× ×—×•×‘×”");
                isValid = false;
            } else if (!validateEmailClient(email)) {
                errors.push("×›×ª×•×‘×ª ××™××™×™×œ ×œ× ×—×•×§×™×ª. ×™×© ×œ×”×›× ×™×¡ ×›×ª×•×‘×ª ×ª×§×™× ×” ×¢× ×¡×™×•××ª");
                emailErrorDiv.textContent = "×›×ª×•×‘×ª ××™××™×™×œ ×œ× ×—×•×§×™×ª";
                isValid = false;
            } else {
                emailErrorDiv.textContent = "";
            }

            // ×‘×“×™×§×ª ×˜×œ×¤×•×Ÿ
            const phone = phoneInput.value.trim();
            if (!phone) {
                errors.push("×©×“×” '×˜×œ×¤×•×Ÿ' ×”×•× ×—×•×‘×”");
                isValid = false;
            } else if (!validatePhoneClient(phone)) {
                errors.push("××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×—×•×§×™");
                phoneErrorDiv.textContent = "×™×© ×œ×”×©×ª××© ×‘×¡×¤×¨×•×ª ×‘×œ×‘×“, ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×—×•×§×™";
                isValid = false;
            } else {
                phoneErrorDiv.textContent = "";
            }

            // ×‘×“×™×§×ª ×©× ×”×™×œ×“
            const childName = document.getElementById("child_name").value.trim();
            if (!childName) {
                errors.push("×©×“×” '×©× ×”×™×œ×“/×”' ×”×•× ×—×•×‘×”");
                isValid = false;
            } else if (!validateHebrewName(childName)) {
                errors.push("×©× ×”×™×œ×“/×” ××™× ×• ×—×•×§×™. ×™×© ×œ×”×©×ª××© ×¨×§ ×‘××•×ª×™×•×ª ×‘×¢×‘×¨×™×ª");
                isValid = false;
            }

            // ×‘×“×™×§×ª ×’×™×œ
            const childAge = parseInt(ageInput.value);
            if (!childAge || childAge < 6 || childAge > 13) {
                errors.push("×™×© ×œ×”×›× ×™×¡ ×’×™×œ ×ª×§×™×Ÿ ×‘×™×Ÿ 6 ×œ-13");
                isValid = false;
            }

            // ×‘×“×™×§×ª ××’×“×¨
            if (!genderSelect.value) {
                errors.push("×™×© ×œ×‘×—×•×¨ ×‘×Ÿ ××• ×‘×ª");
                isValid = false;
            }

            // ×‘×“×™×§×ª ×§×•×¨×¡
            if (!courseSelect.value) {
                errors.push("×™×© ×œ×‘×—×•×¨ ×§×•×¨×¡");
                isValid = false;
            }

            // ×‘×“×™×§×ª ×¡×•×’ ×§×‘×•×¦×”
            if (!groupSelect.value) {
                errors.push("×™×© ×œ×‘×—×•×¨ ×¡×•×’ ×§×‘×•×¦×”");
                isValid = false;
            }

            // ×”×¦×’×ª ×©×’×™××•×ª
            if (!isValid && errors.length > 0) {
                alert("× ××¦××• ×”×©×’×™××•×ª ×”×‘××•×ª:\n\n" + errors.join("\n"));
            }

            return isValid;
        }

        // ×‘×“×™×§×ª ××™××™×™×œ ×‘×–××Ÿ ×××ª
        emailInput.addEventListener("blur", () => {
            const email = emailInput.value.trim();
            if (!validateEmailClient(email) && email !== "") {
                emailErrorDiv.textContent = "×›×ª×•×‘×ª ××™××™×™×œ ×œ× ×—×•×§×™×ª. ×™×© ×œ×”×›× ×™×¡ ×›×ª×•×‘×ª ×ª×§×™× ×” ×¢× ×¡×™×•××ª, ×œ×“×•×’××” example@gmail.com";
            } else {
                emailErrorDiv.textContent = "";
            }
        });

        // ×‘×“×™×§×ª ×˜×œ×¤×•×Ÿ ×‘×–××Ÿ ×××ª
        phoneInput.addEventListener("blur", () => {
            const phone = phoneInput.value.trim();
            if (!validatePhoneClient(phone) && phone !== "") {
                phoneErrorDiv.textContent = "××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×—×•×§×™.";
            } else {
                phoneErrorDiv.textContent = "";
            }
        });

        function updateGroupsByAge() {
            const age = parseInt(ageInput.value);
            const gender = genderSelect.value;
            const selectedCourse = courseSelect.value;

            groupSelect.innerHTML = '<option value="" disabled selected>×‘×—×¨/×™ ×¡×•×’ ×§×‘×•×¦×”</option>';

            if (isNaN(age)) return;

            if (age >= 6 && age <= 10 && allCourses[gender][selectedCourse]["small"].capacity > 0) {
                addOption("small", "×§×‘×•×¦×” ×§×˜× ×” ×¢×“ 7 ×™×œ×“×™×, ×’×™×œ××™ 6â€“10");
            }
            if (age >= 8 && age <= 13 && allCourses[gender][selectedCourse]["regular"].capacity > 0) {
                addOption("regular", "×§×‘×•×¦×” ×¨×’×™×œ×” ×¢×“ 10 ×™×œ×“×™× ×’×™×œ××™ 8â€“13");
            }
        }

        function addOption(value, text) {
            const selectedCourse = courseSelect.value;
            let displayText = text;

            if (prices[value]) {
                const monthlyPrice = prices[value];
                displayText += ` (${monthlyPrice}* ${prices.months} ×—×•×“×©×™×)`;
            }

            if (selectedCourse) {
                const hasPlace = courseStatus[selectedCourse]?.[value];
                if (!hasPlace) {
                    displayText += " (××œ×)";
                }
            }

            const option = document.createElement("option");
            option.value = value;
            option.textContent = displayText;
            groupSelect.appendChild(option);
        }

        function updateCourses() {
            const gender = genderSelect.value;
            courseSelect.innerHTML = '<option value="" disabled selected>×‘×—×¨/×™ ×§×•×¨×¡</option>';

            if (!gender || !allCourses[gender]) return;

            for (const [courseName, course] of Object.entries(allCourses[gender])) {
                const smallCap = course.small?.capacity || 0;
                const regularCap = course.regular?.capacity || 0;

                if (smallCap > 0 || regularCap > 0) {
                    const option = document.createElement("option");
                    option.value = courseName;
                    option.textContent = courseName;
                    courseSelect.appendChild(option);
                }
            }
            updateButton();
        }

        function updateButton() {
            const selectedCourse = courseSelect.value;
            const selectedGroup = groupSelect.value;

            if (!selectedCourse || !selectedGroup) return;

            const hasPlace = courseStatus[selectedCourse]?.[selectedGroup];

            if (hasPlace) {
                submitButton.textContent = "×”×¨×©××”";
                submitButton.className = "btn-register";
            } else {
                submitButton.textContent = "×”×¦×˜×¨×¤×•×ª ×œ×¨×©×™××ª ×”××ª× ×”";
                submitButton.className = "btn-waiting";
            }
        }

        // ×××–×™× ×™× ×œ×©×™× ×•×™×™ ×”×‘×—×™×¨×”
        genderSelect.addEventListener("change", updateCourses);
        courseSelect.addEventListener("change", updateButton);
        groupSelect.addEventListener("change", updateButton);
        ageInput.addEventListener("input", updateGroupsByAge);
        courseSelect.addEventListener("change", updateGroupsByAge);

        // ×‘×“×™×§×ª ×”×˜×•×¤×¡ ×‘×©×œ×™×—×” ×¨×’×™×œ×”
        form.addEventListener("submit", (e) => {
            if (!validateAllFields()) {
                e.preventDefault();
                return false;
            }
        });

        // ×¤×¨×˜×™ ×—×œ×•× ×™×ª ×”×ª×©×œ×•×
        const modal = document.getElementById("paymentModal");
        const closeModal = document.getElementById("closeModal");
        const payButton = document.getElementById("payButton");
        const paymentRadios = document.getElementsByName("payment_type");
        const insuranceOptions = document.getElementById("insuranceOptions");

        // ×”×˜×™×¤×•×œ ×‘×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×”×¨×©××” - ×›××Ÿ ×”×‘×“×™×§×” ×”×—×“×©×”!
        submitButton.addEventListener("click", (e) => {
            const privacyCheckbox = document.getElementById("privacy");

            // ×‘×“×™×§×” ×× ××¡×•××Ÿ ×”-checkbox
            if (!privacyCheckbox.checked) {
                alert("×—×•×‘×” ×œ××©×¨ ××ª ××“×™× ×™×•×ª ×”×¤×¨×˜×™×•×ª ×›×“×™ ×œ×”××©×™×š ×‘×”×¨×©××”");
                e.preventDefault(); // ×¢×•×¦×¨ ××ª ×”×”××©×š
                return;
            }
            const selectedCourse = courseSelect.value;
            const selectedGroup = groupSelect.value;
            const hasPlace = courseStatus[selectedCourse]?.[selectedGroup];

            if (hasPlace) {
                e.preventDefault(); // ××•× ×¢ ×©×œ×™×—×ª ×”×˜×•×¤×¡ ×”×¨×’×™×œ×”

                // ×‘×“×™×§×ª ×›×œ ×”×©×“×•×ª ×œ×¤× ×™ ×¤×ª×™×—×ª ×—×œ×•× ×™×ª ×”×ª×©×œ×•×
                if (!validateAllFields()) {
                    return; // ×× ×™×© ×©×’×™××•×ª, ×œ× ×¤×•×ª×—×™× ××ª ×”×—×œ×•× ×™×ª
                }

                // ××™×¤×•×¡ ×”×‘×—×™×¨×•×ª
                paymentRadios.forEach(r => r.checked = false);
                const insuranceRadios = document.getElementsByName("insurance_type");
                insuranceRadios.forEach(r => r.checked = false);
                insuranceOptions.style.display = "none";

                // ×”×¡×¨×ª ×˜×§×¡×˜ ×”×ª×—×™×™×‘×•×™×•×ª ×× ×§×™×™×
                const commitmentsDiv = document.getElementById("commitments-text");
                if (commitmentsDiv) commitmentsDiv.remove();

                modal.style.display = "block";
            }
            // ×× ××™×Ÿ ××§×•× â€“ ×”×˜×•×¤×¡ × ×©×œ×— ×›×¨×’×™×œ (×œ×¨×©×™××ª ×”××ª× ×”)
        });

        closeModal.addEventListener("click", () => {
            modal.style.display = "none";
        });

        // ×”×¦×’×ª ×‘×—×™×¨×ª ×§×•×¤×ª ×—×•×œ×™× ×¨×§ ×× × ×‘×—×¨ ×ª×©×œ×•× ×“×¨×š ×§×•×¤×ª ×—×•×œ×™×
        paymentRadios.forEach(radio => {
            radio.addEventListener("change", () => {
                if (radio.value === "insurance" && radio.checked) {
                    insuranceOptions.style.display = "block";
                } else {
                    insuranceOptions.style.display = "none";
                }
            });
        });

        // ×©×œ×™×—×ª ×”× ×ª×•× ×™× ×œ×©×¨×ª ×›××• submit ×¨×’×™×œ
        payButton.addEventListener("click", () => {




            let paymentType = document.querySelector('input[name="payment_type"]:checked');
            if (!paymentType) {
                alert("×™×© ×œ×‘×—×•×¨ ×¡×•×’ ×ª×©×œ×•×");
                return;
            }

            // ××—×™×§×” ×©×œ hidden inputs ×§×•×“××™× ×× ×§×™×™××™×
            ['payment_type', 'insurance', 'commitments'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.remove();
            });

            // ×”×•×¡×¤×ª hidden input ×œ×ª×©×œ×•×
            const inputPayment = document.createElement("input");
            inputPayment.type = "hidden";
            inputPayment.name = "payment_type";
            inputPayment.id = "payment_type";
            inputPayment.value = paymentType.value;
            form.appendChild(inputPayment);

            if (paymentType.value === "insurance") {
                const selectedInsurance = document.querySelector('input[name="insurance_type"]:checked');
                if (!selectedInsurance) {
                    alert("×™×© ×œ×‘×—×•×¨ ×§×•×¤×ª ×—×•×œ×™×");
                    return;
                }

                const inputInsurance = document.createElement("input");
                inputInsurance.type = "hidden";
                inputInsurance.name = "insurance";
                inputInsurance.id = "insurance";
                inputInsurance.value = selectedInsurance.value;
                form.appendChild(inputInsurance);

                const inputCommitments = document.createElement("input");
                inputCommitments.type = "hidden";
                inputCommitments.name = "commitments";
                inputCommitments.id = "commitments";
                inputCommitments.value = "×œ×";
                form.appendChild(inputCommitments);
            }

            form.submit(); // ×©×•×œ×— ××ª ×”×˜×•×¤×¡ ×¨×’×™×œ
        });

        // ×”×¦×’×ª ××¡×¤×¨ ×”×ª×—×™×™×‘×•×™×•×ª
        paymentRadios.forEach(radio => {
            radio.addEventListener("change", () => {
                if (radio.value === "insurance" && radio.checked) {
                    insuranceOptions.style.display = "block";
                    const selectedGroup = groupSelect.value;
                    const selectedInsurance = document.querySelector('input[name="insurance_type"]:checked');
                    let commitmentsNumber = 0;

                    if (selectedInsurance) {
                        if (selectedInsurance.value === "×××•×—×“×ª") {
                            commitmentsNumber = 20;
                        } else if (selectedInsurance.value === "×œ××•××™×ª") {
                            if (selectedGroup === "small") commitmentsNumber = 16;
                            if (selectedGroup === "regular") commitmentsNumber = 20;
                        }
                    }

                    // ×”×¦×’×ª ×”×˜×§×¡×˜
                    let commitmentsDiv = document.getElementById("commitments-text");
                    if (!commitmentsDiv) {
                        commitmentsDiv = document.createElement("div");
                        commitmentsDiv.id = "commitments-text";
                        commitmentsDiv.style.color = "blue";
                        commitmentsDiv.style.marginTop = "5px";
                        insuranceOptions.appendChild(commitmentsDiv);
                    }
                    commitmentsDiv.textContent = `××¡×¤×¨ ×”×”×ª×—×™×™×‘×•×™×•×ª ×”× ×“×¨×©: ${commitmentsNumber}`;
                } else {
                    insuranceOptions.style.display = "none";
                    const commitmentsDiv = document.getElementById("commitments-text");
                    if (commitmentsDiv) commitmentsDiv.remove();
                }
            });
        });

        // ×××–×™× ×™× ×’× ×œ×©×™× ×•×™ ×‘×§×•×¤×” ×œ××—×¨ ×©×”××©×ª××© ×¡×™××Ÿ ××•×ª×”
        const insuranceRadios = document.querySelectorAll('input[name="insurance_type"]');
        insuranceRadios.forEach(ins => {
            ins.addEventListener("change", () => {
                const selectedGroup = groupSelect.value;
                let commitmentsNumber = 20;

                if (ins.value === "×××•×—×“×ª") {
                    commitmentsNumber = 20;
                } else if (ins.value === "×œ××•××™×ª") {
                    if (selectedGroup === "small") commitmentsNumber = 20;
                    if (selectedGroup === "regular") commitmentsNumber = 16;
                }

                let commitmentsDiv = document.getElementById("commitments-text");
                if (!commitmentsDiv) {
                    commitmentsDiv = document.createElement("div");
                    commitmentsDiv.id = "commitments-text";
                    commitmentsDiv.style.color = "blue";
                    commitmentsDiv.style.marginTop = "5px";
                    insuranceOptions.appendChild(commitmentsDiv);
                }
                commitmentsDiv.textContent = `××¡×¤×¨ ×”×”×ª×—×™×™×‘×•×™×•×ª ×”× ×“×¨×©: ${commitmentsNumber}`;
            });
        });
    </script> -->
</body>
<script>
    // 1. ×”×’×“×¨×•×ª ×•××©×ª× ×™× (×”×©××¨×ª×™ ×‘×“×™×•×§ ×›××• ××¦×œ×š)
    const allCourses = {{ courses | tojson | safe }};
    const courseStatus = {{ course_status | tojson | safe }};
    const prices = {{ prices | tojson | safe }};

    const form = document.querySelector("form");
    const submitButton = document.querySelector(".btn-register");
    const genderSelect = document.getElementById("child_gender");
    const courseSelect = document.getElementById("course");
    const groupSelect = document.getElementById("group_type");
    const ageInput = document.getElementById("child_age");
    const modal = document.getElementById("paymentModal");

    // ×¤×•× ×§×¦×™×•×ª ×”×¢×–×¨ ×©×œ×š (×”×©××¨×ª×™ ×œ×œ× ×©×™× ×•×™)
    function validateEmailClient(email) {
        const regex = /^[\w\.-]+@[\w\.-]+\.[a-zA-Z]{2,}$/;
        return regex.test(email);
    }

    function validatePhoneClient(phone) {
        const regex = /^0(?:[23489]|5[0-9])\d{7}$/;
        return regex.test(phone);
    }

    // --- ×”×ª×™×§×•×Ÿ ×”××¨×›×–×™ ×‘×‘×“×™×§×” ×‘×œ×—×™×¦×” ---
    submitButton.addEventListener("click", (e) => {
        // ×. ×¨×©×™××ª ×”×©×“×•×ª ×œ×‘×“×™×§×ª "×—×•×‘×”"
        const requiredFields = [
            { id: "parent_name", name: "×©× ×”×•×¨×”" },
            { id: "parent_surname", name: "×©× ××©×¤×—×”" },
            { id: "email", name: "××™××™×™×œ" },
            { id: "phone", name: "×˜×œ×¤×•×Ÿ" },
            { id: "child_name", name: "×©× ×”×™×œ×“/×”" },
            { id: "child_age", name: "×’×™×œ" },
            { id: "id", name: "×ª×¢×•×“×ª ×–×”×•×ª" },
            { id: "child_gender", name: "×‘×Ÿ/×‘×ª" },
            { id: "course", name: "×§×•×¨×¡" },
            { id: "group_type", name: "×¡×•×’ ×§×‘×•×¦×”" }
        ];

        // 1. ×‘×“×™×§×” ×©×›×œ×•× ×œ× ×¨×™×§
        for (let field of requiredFields) {
            const input = document.getElementById(field.id);
            if (!input || !input.value.trim()) {
                alert(`× × ×œ××œ× ××ª ×›×œ ×”×¤×¨×˜×™×: ×©×“×” '${field.name}' ×—×¡×¨.`);
                e.preventDefault();
                return;
            }
        }

        // 2. ×‘×“×™×§×ª ×¤×•×¨××˜ ××™××™×™×œ
        const emailValue = document.getElementById("email").value.trim();
        if (!validateEmailClient(emailValue)) {
            alert("× × ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ××™××™×™×œ ×ª×§×™× ×” (×œ×“×•×’××”: example@mail.com).");
            e.preventDefault();
            return;
        }

        // 3. ×‘×“×™×§×ª ×¤×•×¨××˜ ×˜×œ×¤×•×Ÿ (10 ×¡×¤×¨×•×ª ×‘×“×™×•×§)
        const phoneValue = document.getElementById("phone").value.trim();
        if (phoneValue.length !== 10 || !validatePhoneClient(phoneValue)) {
            alert("××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×—×™×™×‘ ×œ×”×›×™×œ 10 ×¡×¤×¨×•×ª ×‘×¤×•×¨××˜ ×ª×§×™×Ÿ.");
            e.preventDefault();
            return;
        }

        // 4. ×‘×“×™×§×ª ×ª×¢×•×“×ª ×–×”×•×ª (9 ×¡×¤×¨×•×ª ×‘×“×™×•×§)
        const idValue = document.getElementById("id").value.trim();
        if (idValue.length !== 9 || isNaN(idValue)) {
            alert("×ª×¢×•×“×ª ×–×”×•×ª ×—×™×™×‘×ª ×œ×”×›×™×œ 9 ×¡×¤×¨×•×ª ×‘×“×™×•×§ (××¡×¤×¨×™× ×‘×œ×‘×“).");
            e.preventDefault();
            return;
        }
        const ageValue = parseInt(document.getElementById("child_age").value);
        if (isNaN(ageValue) || ageValue < 8 || ageValue > 13) {
            alert("×”×’×™×œ ×—×™×™×‘ ×œ×”×™×•×ª ×‘×™×Ÿ 8 ×œ-13.");
            e.preventDefault();
            return;
        }

        // 5. ×‘×“×™×§×ª ××“×™× ×™×•×ª ×¤×¨×˜×™×•×ª
        if (!document.getElementById("privacy").checked) {
            alert("×—×•×‘×” ×œ××©×¨ ××ª ××“×™× ×™×•×ª ×”×¤×¨×˜×™×•×ª ×›×“×™ ×œ×”××©×™×š.");
            e.preventDefault();
            return;
        }

        // --- ×× ×”×›×œ ×¢×‘×¨ ××ª ×”×‘×“×™×§×•×ª ---
        const selectedCourse = courseSelect.value;
        const selectedGroup = groupSelect.value;
        const hasPlace = courseStatus[selectedCourse]?.[selectedGroup];

        if (hasPlace) {
            e.preventDefault(); // ×¢×•×¦×¨ ××ª ×”×©×œ×™×—×” ×›×“×™ ×œ×¤×ª×•×— ××ª ×”××•×“××œ
            modal.style.display = "block";
        }
        // ×× ××™×Ÿ ××§×•× - ×”×˜×•×¤×¡ ×™×™×©×œ×— ×¨×’×™×œ ×œ×©×¨×ª (×œ×¨×©×™××ª ×”××ª× ×”)
    });

    // --- ×©××¨ ×”×¤×•× ×§×¦×™×•×ª ×©×œ ×¢×“×›×•×Ÿ ×”×§×•×¨×¡×™× ×•×”×§×‘×•×¦×•×ª (× ×©××¨×• ×›×¤×™ ×©×”×™×•) ---
    function updateCourses() {
        const gender = genderSelect.value;
        courseSelect.innerHTML = '<option value="" disabled selected>×‘×—×¨/×™ ×§×•×¨×¡</option>';
        if (!gender || !allCourses[gender]) return;
        Object.keys(allCourses[gender]).forEach(courseName => {
            const option = document.createElement("option");
            option.value = courseName;
            option.textContent = courseName;
            courseSelect.appendChild(option);
        });
    }

    function updateGroupsByAge() {
        const age = parseInt(ageInput.value);
        const gender = genderSelect.value;
        const selectedCourse = courseSelect.value;

        // ××™×¤×•×¡ ×¡×œ×§×˜ ×”×§×‘×•×¦×•×ª
        groupSelect.innerHTML = '<option value="" disabled selected>×‘×—×¨/×™ ×¡×•×’ ×§×‘×•×¦×”</option>';

        // ×‘×“×™×§×” ×©×”× ×ª×•× ×™× ×§×™×™××™× (××•× ×¢ ×§×¨×™×¡×•×ª)
        if (isNaN(age) || !gender || !selectedCourse || !allCourses[gender] || !allCourses[gender][selectedCourse]) return;

        const courseData = allCourses[gender][selectedCourse];

        // 1. ××¦×™×’×™× ×§×‘×•×¦×” ×§×˜× ×” ×¨×§ ×× ×”×™× ×§×™×™××ª ×‘× ×ª×•× ×™× ×•×’× ×”×’×™×œ ××ª××™× (8-10)
        if (courseData["small"] && age >= 8 && age <= 10) {
            addOption("small", "×§×‘×•×¦×” ×§×˜× ×” (×’×™×œ××™ 8â€“10)");
        }

        // 2. ××¦×™×’×™× ×§×‘×•×¦×” ×¨×’×™×œ×” ×¨×§ ×× ×”×™× ×§×™×™××ª ×‘× ×ª×•× ×™× ×•×’× ×”×’×™×œ ××ª××™× (8-13)
        if (courseData["regular"] && age >= 8 && age <= 13) {
            addOption("regular", "×§×‘×•×¦×” ×¨×’×™×œ×” (×’×™×œ××™ 8â€“13)");
        }

        updateButton(); // ××¢×“×›×Ÿ ××ª ×”×˜×§×¡×˜ ×©×œ ×”×›×¤×ª×•×¨
    }

    function addOption(value, text) {
        let displayText = text;
        if (prices[value]) {
            displayText += ` (${prices[value]} ×©"×— ×œ×—×•×“×©)`;
        }
        const option = document.createElement("option");
        option.value = value;
        option.textContent = displayText;
        groupSelect.appendChild(option);
    }

    // ×”×—×–×¨×ª ×¤×•× ×§×¦×™×™×ª ×¢×“×›×•×Ÿ ×”×›×¤×ª×•×¨ ×”××§×•×¨×™×ª ×©×œ×š
    function updateButtonText() {
        const selectedCourse = courseSelect.value;
        const selectedGroup = groupSelect.value;
        if (!selectedCourse || !selectedGroup) return;

        const hasPlace = courseStatus[selectedCourse]?.[selectedGroup];

        if (hasPlace) {
            submitButton.textContent = "×”×¨×©××”";
            submitButton.className = "btn-register";
        } else {
            submitButton.textContent = "×”×¦×˜×¨×¤×•×ª ×œ×¨×©×™××ª ×”××ª× ×”";
            submitButton.className = "btn-waiting";
        }
    }

    genderSelect.addEventListener("change", updateCourses);
    courseSelect.addEventListener("change", updateGroupsByAge);
    ageInput.addEventListener("input", updateGroupsByAge);
    groupSelect.addEventListener("change", updateButtonText);

    document.getElementById("closeModal").onclick = () => modal.style.display = "none";
</script>

</html>