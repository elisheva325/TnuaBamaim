<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>× ×¨×©××™× ×œ×§×•×¨×¡</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='view_registration.css') }}">
</head>

<body>
    <div class="page-wrapper">
        <div class="page-card">
            <div class="page-header">
                <div class="header-side right">
                    <a href="{{ url_for('admin_dashboard') }}" class="back-btn">×—×–×¨×” ×œ×œ×•×— ×× ×”×œ</a>
                </div>
                <h2 class="header-title">× ×¨×©××™× ×œ×§×•×¨×¡: {{ course }} ({{ '×§×‘×•×¦×” ×§×˜× ×”' if group_type=='small' else '×§×‘×•×¦×”
                    ×¨×’×™×œ×”' }})</h2>
                <div class="header-side left">
                    <button id="addBtn" class="btn">â• ×”×•×¡×£ × ×¨×©×</button>
                </div>
            </div>
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, msg in messages %}
            {% if category == 'error' %}
            <div style="color: red; margin-bottom:10px;">{{ msg }}</div>
            {% else %}
            <div style="color: green; margin-bottom:10px;">{{ msg }}</div>
            {% endif %}
            {% endfor %}
            {% endif %}
            {% endwith %}

            <div id="addModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h3>×”×•×¡×¤×ª × ×¨×©×</h3>
                    <form method="POST"
                        action="{{ url_for('add_registrant', gender=gender, course=course, group_type=group_type) }}">
                        <label>×©× ×”×”×•×¨×”:</label><br>
                        <input type="text" name="parent_name" required><br>
                        <label>×©× ××©×¤×—×”:</label><br>
                        <input type="text" name="parent_surname" required><br>
                        <label>××™××™×™×œ:</label><br>
                        <input type="email" name="email" required><br>
                        <label>×˜×œ×¤×•×Ÿ:</label><br>
                        <input type="text" name="phone" required><br>
                        <label>×©× ×”×™×œ×“/×”:</label><br>
                        <input type="text" name="child_name" required><br>
                        <label>×’×™×œ:</label><br>
                        <input type="number" name="child_age" min="1" required><br><br>
                        <button type="submit" class="btn">×”×•×¡×£</button>
                    </form>
                </div>
            </div>

            <h3>×¨×©×•××™×</h3>
            {% if registered_list %}
            <div class="section-card">
                <table>
                    <tr>
                        <th>×©× ×”×™×œ×“/×”</th>
                        <th>×’×™×œ</th>
                        <th>××’×“×¨</th>
                        <th>×©× ×”×”×•×¨×”</th>
                        <th>×˜×œ×¤×•×Ÿ</th>
                        <th>××™××™×™×œ</th>
                        <th>×§×•×¤×ª ×—×•×œ×™×</th>
                        <th>×”×ª×—×™×™×‘×•×™×•×ª</th>
                        <th>×ª×©×œ×•× × ×•×¡×£</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                    {% for r in registered_list %}
                    <tr>
                        <td>{{ r.child_name }}</td>
                        <td>{{ r.child_age }}</td>
                        <td>{{ '×‘×Ÿ' if r.child_gender == 'boys' else '×‘×ª' }}</td>
                        <td>{{ r.parent_name }} {{ r.parent_surname }}</td>
                        <td>{{ r.phone }}</td>
                        <td>{{ r.email }}</td>
                        <td>{{ r.insurance if r.insurance else "-" }}</td>
                        <td>
                            {% if r.commitments and r.commitments != "-" %}
                            {{ r.commitments }}
                            <form method="POST" action="{{ url_for('toggle_commitment') }}" style="display:inline;">
                                <input type="hidden" name="email" value="{{ r.email }}">
                                <input type="hidden" name="child_name" value="{{ r.child_name }}">
                                <input type="hidden" name="course" value="{{ r.course }}">
                                <input type="hidden" name="group_type" value="{{ r.group_type }}">
                                <input type="hidden" name="gender" value="{{ gender }}">
                                <button type="submit" class="toggle-btn">×©× ×”</button>
                            </form>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <!-- <td>{{ r.commitments if r.commitments  else "-" }}</td> -->
                        <td>
                            {{ r.extra_payment if r.extra_payment else "-" }}
                            {% if r.card_token or (r.icount and r.icount.card_token) %}
                            <br>
                            <button type="button" class="toggle-btn"
                                onclick="openChargeModal('{{ r.email }}', '{{ r.child_name }}', '{{ r.course }}', '{{ r.group_type }}')">
                                ğŸ’³ ×—×™×•×‘ ×—×•×–×¨
                            </button>
                            {% endif %}
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('cancel_registration') }}">
                                <input type="hidden" name="email" value="{{ r.email }}">
                                <input type="hidden" name="child_name" value="{{ r.child_name }}">
                                <input type="hidden" name="course" value="{{ r.course }}">
                                <input type="hidden" name="group_type" value="{{ r.group_type }}">
                                <input type="hidden" name="list_type" value="registered">
                                <input type="hidden" name="gender" value="{{ gender }}">
                                <button type="submit" class="cancel-btn">âŒ ×‘×˜×œ</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
                {% else %}
                <p>××™×Ÿ ×¨×©×•××™× ×›×¨×’×¢.</p>
                {% endif %}
            </div>
            <h3>×¨×©×™××ª ×”××ª× ×”</h3>
            {% if waiting_list %}
            <div class="section-card">
                <table>
                    <tr>
                        <th>×©× ×”×™×œ×“/×”</th>
                        <th>×’×™×œ</th>
                        <th>××’×“×¨</th>
                        <th>×©× ×”×”×•×¨×”</th>
                        <th>×˜×œ×¤×•×Ÿ</th>
                        <th>××™××™×™×œ</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                    {% for w in waiting_list %}
                    <tr>
                        <td>{{ w.child_name }}</td>
                        <td>{{ w.child_age }}</td>
                        <td>{{ '×‘×Ÿ' if w.child_gender == 'boys' else '×‘×ª' }}</td>

                        <td>{{ w.parent_name }} {{ w.parent_surname }}</td>
                        <td>{{ w.phone }}</td>
                        <td>{{ w.email }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('cancel_registration') }}">
                                <input type="hidden" name="email" value="{{ w.email }}">
                                <input type="hidden" name="child_name" value="{{ w.child_name }}">
                                <input type="hidden" name="course" value="{{ w.course }}">
                                <input type="hidden" name="group_type" value="{{ w.group_type }}">
                                <input type="hidden" name="list_type" value="waiting_list">
                                <input type="hidden" name="gender" value="{{ gender }}">
                                <button type="submit" class="cancel-btn">âŒ ×‘×˜×œ</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
            {% else %}
            <p>××™×Ÿ ××£ ××—×“ ×‘×¨×©×™××ª ×”××ª× ×”.</p>
            {% endif %}
        </div>
    </div>
</body>

<script>
    function openChargeModal(email, childName, course, groupType) {
        document.getElementById("chargeEmail").value = email;
        document.getElementById("chargeChild").value = childName;
        document.getElementById("chargeCourse").value = course;
        document.getElementById("chargeGroup").value = groupType;
        document.getElementById("chargeModal").style.display = "block";
    }

    document.getElementById("closeCharge").onclick = function () {
        document.getElementById("chargeModal").style.display = "none";
    };
    window.onclick = function (event) {
        if (event.target == document.getElementById("chargeModal")) {
            document.getElementById("chargeModal").style.display = "none";
        }
    };

    var modal = document.getElementById("addModal");
    var btn = document.getElementById("addBtn");
    var span = document.getElementsByClassName("close")[0];

    window.addEventListener("pageshow", function (event) {
        if (event.persisted) {
            if (document.referrer) {
                window.location.href = document.referrer;
            } else {
                window.location.href = "/";
            }
        }
    });

    btn.onclick = function () { modal.style.display = "block"; }
    span.onclick = function () { modal.style.display = "none"; }
    window.onclick = function (event) {
        if (event.target == modal) { modal.style.display = "none"; }
    }
</script>

</html>